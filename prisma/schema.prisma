// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant Model (Multi-tenant architecture)
model Tenant {
  id                String    @id @default(uuid())
  name              String
  slug              String    @unique
  email             String    @unique
  phone             String?
  address           String?
  isActive          Boolean   @default(true)
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  subscriptionPlan  String? // BASIC, PRO, ENTERPRISE
  previousPlan      String? // untuk revert
  temporaryUpgrade  Boolean   @default(false)
  features          Json? // cache aktif fitur saat ini
  tenantsActive     Int       @default(1)
  tenantsLimit      Int       @default(1)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  users               User[]
  products            Product[]
  orders              Order[]
  transactions        Transaction[]
  customers           Customer[]
  members             Member[]
  employees           Employee[]
  outlets             Outlet[]
  reports             Report[]
  addons              TenantAddon[]
  subscriptions       Subscription[]
  subscriptionHistory SubscriptionHistory[]
  receiptTemplates    ReceiptTemplate[]
  discounts           Discount[]
  paymentMappings     PaymentMapping[]
  productAdjustments  ProductAdjustment[]
  auditLogs           AuditLog[]
  webhooks            Webhook[]
  suppliers           Supplier[]
  purchaseOrders      PurchaseOrder[]
  stockTransfers      StockTransfer[]
  stockValuations     StockValuation[]
  backupLogs          BackupLog[]
  cashShifts          CashShift[]
  storeShifts         StoreShift[]
  courierConfigs      CourierConfig[]

  @@map("tenants")
}

// User Model
model User {
  id                   String    @id @default(uuid())
  tenantId             String
  email                String
  password             String
  name                 String
  role                 UserRole  @default(CASHIER)
  isActive             Boolean   @default(true)
  permissions          Json? // Store user-specific permissions (e.g., canEditOrders, canDeleteOrders, canEditReports, etc.)
  lastLogin            DateTime?
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String? // JSON array of hashed backup codes
  passwordHistory      String? // JSON array of previous passwords (hashed)
  passwordChangedAt    DateTime?
  mustChangePassword   Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders             Order[]
  transactions       Transaction[]
  cashShifts         CashShift[]
  productAdjustments ProductAdjustment[]
  auditLogs          AuditLog[]
  storeShifts        StoreShift[]        @relation("StoreShiftOpener")
  deviceTokens       DeviceToken[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN_TENANT
  SUPERVISOR
  CASHIER
  KITCHEN
}

// Product Model
model Product {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  description   String?
  sku           String?
  barcode       String?
  price         Decimal  @db.Decimal(10, 2)
  cost          Decimal? @db.Decimal(10, 2) // Harga pokok/beli (untuk produk titipan)
  stock         Int      @default(0)
  minStock      Int      @default(0)
  category      String?
  image         String?
  emoji         String?
  isActive      Boolean  @default(true)
  isConsignment Boolean  @default(false) // Produk titipan dari orang lain
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderItems         OrderItem[]
  adjustments        ProductAdjustment[]
  purchaseOrderItems PurchaseOrderItem[]
  stockTransferItems StockTransferItem[]
  stockValuations    StockValuation[]

  @@index([tenantId])
  @@index([tenantId, sku])
  @@index([tenantId, isConsignment])
  @@index([tenantId, category, isActive])
  @@index([tenantId, isActive])
  @@index([tenantId, name])
  @@map("products")
}

// Product Adjustment Model (for tracking stock adjustments)
model ProductAdjustment {
  id           String   @id @default(uuid())
  tenantId     String
  productId    String
  userId       String // User who made the adjustment
  storeShiftId String? // Link ke StoreShift (shift global toko)
  type         String // INCREASE, DECREASE
  quantity     Int // Amount adjusted
  reason       String // Reason for adjustment
  stockBefore  Int // Stock before adjustment
  stockAfter   Int // Stock after adjustment
  createdAt    DateTime @default(now())

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id])
  storeShift StoreShift? @relation(fields: [storeShiftId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, productId])
  @@index([tenantId, createdAt])
  @@index([tenantId, storeShiftId])
  @@map("product_adjustments")
}

// Order Model
model Order {
  id                    String      @id @default(uuid())
  idempotencyKey        String?     @unique
  tenantId              String
  orderNumber           String      @unique
  userId                String
  customerId            String?
  memberId              String? // For member orders (temporary customer name stored in memberId as JSON)
  outletId              String?
  storeShiftId          String? // Link ke StoreShift (shift global toko)
  total                 Decimal     @db.Decimal(10, 2)
  discount              Decimal     @default(0) @db.Decimal(10, 2)
  subtotal              Decimal     @db.Decimal(10, 2)
  status                OrderStatus @default(PENDING)
  sendToKitchen         Boolean     @default(false)
  kitchenStatus         String? // PENDING, PROCESSING, READY, COMPLETED
  temporaryCustomerName String? // Temporary customer name (not saved to DB)
  notes                 String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])
  member      Member?      @relation(fields: [memberId], references: [id])
  outlet      Outlet?      @relation(fields: [outletId], references: [id])
  storeShift  StoreShift?  @relation(fields: [storeShiftId], references: [id], onDelete: SetNull)
  items       OrderItem[]
  transaction Transaction?

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, sendToKitchen])
  @@index([tenantId, createdAt])
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([tenantId, customerId])
  @@index([tenantId, outletId])
  @@index([storeShiftId])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

// Order Item Model
model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) // Harga jual
  cost      Decimal? @db.Decimal(10, 2) // Harga pokok (untuk hitung profit)
  subtotal  Decimal  @db.Decimal(10, 2)
  profit    Decimal? @db.Decimal(10, 2) // Profit = (price - cost) * quantity
  createdAt DateTime @default(now())

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productId, orderId])
  @@map("order_items")
}

// Payment Mapping Model (for Midtrans orderId -> tenantId/itemId mapping)
model PaymentMapping {
  id        String   @id @default(uuid())
  orderId   String   @unique // Midtrans order_id (short format)
  tenantId  String
  itemId    String
  itemType  String // 'addon' or 'subscription'
  itemName  String?
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("PENDING") // PENDING, SETTLED, CANCELLED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([tenantId])
  @@map("payment_mappings")
}

// Transaction Model
model Transaction {
  id            String            @id @default(uuid())
  tenantId      String
  orderId       String            @unique
  userId        String
  amount        Decimal           @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  status        TransactionStatus @default(PENDING)
  reference     String? // Reference number (untuk bank transfer, dll)
  qrCode        String? // QR Code string untuk QRIS manual
  qrCodeImage   String? // URL gambar QR Code (opsional)
  notes         String?
  servedBy      String? // Nama kasir/admin yang melayani (untuk receipt)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([tenantId, paymentMethod, createdAt(sort: Desc)])
  @@index([tenantId, userId])
  @@map("transactions")
}

enum PaymentMethod {
  CASH
  QRIS
  CARD
  E_WALLET
  BANK_TRANSFER
  SHOPEEPAY
  DANA
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Customer Model (Walk-in customers)
model Customer {
  id            String    @id @default(uuid())
  tenantId      String
  name          String
  email         String?
  phone         String?
  address       String?
  birthday      DateTime? // For birthday reminders
  loyaltyPoints Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders    Order[]

  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, name])
  @@index([tenantId, email])
  @@map("customers")
}

// Member Model (Registered members with special discounts)
model Member {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  email         String?
  phone         String
  address       String?
  memberCode    String   @unique
  discountType  String? // PERCENTAGE, FIXED
  discountValue Decimal? @db.Decimal(10, 2)
  isActive      Boolean  @default(true)
  loyaltyPoints Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([tenantId])
  @@index([tenantId, phone])
  @@unique([tenantId, phone])
  @@index([tenantId, memberCode])
  @@map("members")
}

// Employee Model
model Employee {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  email     String
  phone     String?
  position  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("employees")
}

// Outlet Model
model Outlet {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  shiftConfig    Json?    // Array of { name: string, startTime: string, endTime: string }
  operatingHours Json?    // { monday: { open: "08:00", close: "22:00", isOpen: true }, ... }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders      Order[]
  storeShifts StoreShift[]

  @@index([tenantId])
  @@map("outlets")
}

// Report Model (for scheduled reports)
model Report {
  id        String   @id @default(uuid())
  tenantId  String
  type      String
  period    String
  data      Json
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("reports")
}

// Tenant Addon Model
model TenantAddon {
  id           String    @id @default(uuid())
  tenantId     String
  addonId      String
  addonName    String
  addonType    String // ADD_USERS, ADD_PRODUCTS, ADD_OUTLETS, E_COMMERCE, etc.
  status       String    @default("active")
  limit        Int? // Limit for this addon (e.g., 100 products, 5 users)
  currentUsage Int       @default(0) // Current usage count
  subscribedAt DateTime  @default(now())
  expiresAt    DateTime?
  config       Json?
  purchasedBy  String    @default("SELF") // "ADMIN" = dibeli oleh Super Admin, "SELF" = dibeli sendiri oleh tenant

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, addonId])
  @@index([tenantId])
  @@index([tenantId, addonType])
  @@map("tenant_addons")
}

// Subscription Model (for subscription history)
model Subscription {
  id               String   @id @default(uuid())
  tenantId         String
  plan             String // BASIC, PRO, ENTERPRISE
  startDate        DateTime
  endDate          DateTime
  status           String // ACTIVE, EXPIRED, CANCELLED
  amount           Decimal  @db.Decimal(10, 2)
  temporaryUpgrade Boolean  @default(false) // true jika upgrade sementara 1 bulan
  previousPlan     String? // Plan sebelumnya (untuk revert)
  purchasedBy      String   @default("SELF") // "ADMIN" = dibeli oleh Super Admin, "SELF" = dibeli sendiri oleh tenant
  createdAt        DateTime @default(now())

  // Relations
  tenant  Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history SubscriptionHistory[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, temporaryUpgrade])
  @@map("subscriptions")
}

// Subscription History Model (untuk tracking perubahan plan)
model SubscriptionHistory {
  id             String   @id @default(uuid())
  subscriptionId String?
  tenantId       String
  planType       String // BASIC, PRO, ENTERPRISE
  startDate      DateTime
  endDate        DateTime
  price          Decimal  @db.Decimal(10, 2)
  durationDays   Int
  isTemporary    Boolean  @default(false)
  reverted       Boolean  @default(false)
  createdAt      DateTime @default(now())

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, reverted])
  @@map("subscription_history")
}

// Receipt Template Model
model ReceiptTemplate {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  templateType String // DEFAULT, MODERN, MINIMAL, DETAILED, COMPACT
  isDefault    Boolean  @default(false)
  paperSize    String   @default("A4") // A4, THERMAL_58, THERMAL_80
  header       Json?
  footer       Json?
  fields       Json? // Which fields to show
  styles       Json? // CSS styles
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("receipt_templates")
}

// Discount Model (Sistem Diskon Otomatis)
model Discount {
  id                    String    @id @default(uuid())
  tenantId              String
  name                  String // Nama diskon (contoh: "Beli 1 50rb Diskon 20%")
  discountType          String // AMOUNT_BASED, BUNDLE, PRODUCT_BASED
  discountValue         Decimal   @db.Decimal(10, 2) // Nilai diskon (persen atau nominal)
  discountValueType     String // PERCENTAGE, FIXED
  minAmount             Decimal?  @db.Decimal(10, 2) // Minimum total pembelian (untuk AMOUNT_BASED)
  minQuantity           Int? // Minimum quantity (untuk AMOUNT_BASED)
  applicableProducts    Json? // Array product IDs yang dapat diskon (null = semua produk)
  bundleProducts        Json? // Array product IDs untuk bundle (contoh: [productA, productB])
  bundleDiscountProduct String? // Product ID yang mendapat diskon dalam bundle (contoh: hanya productA)
  applicableTo          String    @default("ALL") // ALL, MEMBER_ONLY - Berlaku untuk semua atau hanya member
  isActive              Boolean   @default(true)
  startDate             DateTime?
  endDate               DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("discounts")
}



// Audit Log Model (for tracking all user actions and system changes)
model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String? // Optional: null untuk system-level actions
  userId       String? // Optional: null untuk system actions
  userEmail    String? // Store email untuk reference (jika user dihapus)
  userName     String? // Store name untuk reference (jika user dihapus)
  action       String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, VIEW, etc.
  resource     String // products, orders, users, tenants, etc.
  resourceId   String? // ID dari resource yang diubah
  details      Json? // Additional details (old values, new values, etc.)
  ipAddress    String? // IP address dari request
  userAgent    String? // User agent dari request
  status       String   @default("SUCCESS") // SUCCESS, FAILED, ERROR
  errorMessage String? // Error message jika status FAILED/ERROR
  createdAt    DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

// Webhook Model
model Webhook {
  id         String   @id @default(uuid())
  tenantId   String
  url        String
  events     String[] // Array of event types
  secret     String // Secret for signature verification
  isActive   Boolean  @default(true)
  retryCount Int      @default(3)
  timeout    Int      @default(5000) // milliseconds
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([tenantId])
  @@index([isActive])
  @@map("webhooks")
}

// Webhook Delivery Model
model WebhookDelivery {
  id           String    @id @default(uuid())
  webhookId    String
  event        String
  payload      Json
  status       String // PENDING, SUCCESS, FAILED
  responseCode Int?
  responseBody String?
  attempts     Int       @default(0)
  nextRetryAt  DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime  @default(now())

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}



// Supplier Model
model Supplier {
  id            String   @id @default(uuid())
  tenantId      String
  name          String
  email         String?
  phone         String?
  address       String?
  contactPerson String?
  notes         String?  @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("suppliers")
}

// Purchase Order Model
model PurchaseOrder {
  id           String    @id @default(uuid())
  tenantId     String
  supplierId   String
  orderNumber  String    @unique
  status       String    @default("PENDING") // PENDING, APPROVED, ORDERED, RECEIVED, CANCELLED
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  totalAmount  Decimal   @db.Decimal(10, 2)
  notes        String?   @db.Text
  createdBy    String // User ID
  approvedBy   String? // User ID
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, supplierId])
  @@index([orderNumber])
  @@map("purchase_orders")
}

// Purchase Order Item Model
model PurchaseOrderItem {
  id               String   @id @default(uuid())
  purchaseOrderId  String
  productId        String
  quantity         Int
  unitPrice        Decimal  @db.Decimal(10, 2)
  totalPrice       Decimal  @db.Decimal(10, 2)
  receivedQuantity Int      @default(0)
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

// Stock Transfer Model (transfer antar outlet)
model StockTransfer {
  id             String    @id @default(uuid())
  tenantId       String
  fromOutletId   String
  toOutletId     String
  transferNumber String    @unique
  storeShiftId   String? // Link ke StoreShift (shift global toko)
  status         String    @default("PENDING") // PENDING, IN_TRANSIT, COMPLETED, CANCELLED
  transferDate   DateTime  @default(now())
  receivedDate   DateTime?
  notes          String?   @db.Text
  createdBy      String // User ID
  receivedBy     String? // User ID
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeShift StoreShift?         @relation(fields: [storeShiftId], references: [id], onDelete: SetNull)
  items      StockTransferItem[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, fromOutletId])
  @@index([tenantId, toOutletId])
  @@index([tenantId, storeShiftId])
  @@index([transferNumber])
  @@map("stock_transfers")
}

// Stock Transfer Item Model
model StockTransferItem {
  id               String   @id @default(uuid())
  stockTransferId  String
  productId        String
  quantity         Int
  receivedQuantity Int      @default(0)
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  stockTransfer StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([stockTransferId])
  @@index([productId])
  @@map("stock_transfer_items")
}

// Stock Valuation Model (untuk tracking FIFO, LIFO, Average Cost)
model StockValuation {
  id              String   @id @default(uuid())
  tenantId        String
  productId       String
  valuationType   String // FIFO, LIFO, AVERAGE
  quantity        Int
  unitCost        Decimal  @db.Decimal(10, 2)
  totalCost       Decimal  @db.Decimal(10, 2)
  purchaseDate    DateTime
  purchaseOrderId String? // Link to purchase order if applicable
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([tenantId, productId])
  @@index([tenantId, valuationType])
  @@map("stock_valuations")
}





// Backup Log Model (Super Admin Backup System)
model BackupLog {
  id           String    @id @default(uuid())
  tenantId     String
  status       String // success | failed | email_failed
  generatedAt  DateTime  @default(now())
  emailSentAt  DateTime?
  size         Int? // File size in bytes
  filePath     String
  errorMessage String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, generatedAt])
  @@index([status])
  @@index([generatedAt])
  @@map("backup_logs")
}

// Store Shift Model (Global per Store - Buka Toko)
model StoreShift {
  id        String    @id @default(uuid())
  tenantId  String
  outletId  String // Store/Outlet ID
  shiftType String // pagi, siang, sore, malam
  openedBy  String // User ID yang membuka shift
  openedAt  DateTime  @default(now())
  closedAt  DateTime?
  status    String    @default("open") // open | closed
  modalAwal Decimal?  @db.Decimal(10, 2) // Modal awal shift (optional, untuk kasir)
  catatan   String?   @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  outlet             Outlet              @relation(fields: [outletId], references: [id], onDelete: Cascade)
  opener             User                @relation("StoreShiftOpener", fields: [openedBy], references: [id], onDelete: Cascade)
  orders             Order[] // Orders dalam shift ini
  cashShifts         CashShift[] // Cash shifts kasir dalam shift ini
  productAdjustments ProductAdjustment[] // Product adjustments dalam shift ini
  stockTransfers     StockTransfer[] // Stock transfers dalam shift ini

  @@index([tenantId])
  @@index([outletId])
  @@index([tenantId, outletId])
  @@index([tenantId, outletId, status])
  @@index([tenantId, outletId, shiftType])
  @@index([tenantId, outletId, shiftType, status])
  @@map("store_shifts")
}

// Cash Shift Model (Kasir - Uang Modal & Rekap Fisik)
model CashShift {
  id              String    @id @default(uuid())
  tenantId        String
  storeShiftId    String? // Link ke StoreShift (shift global toko)
  kasirId         String // User ID dengan role CASHIER
  shiftStart      DateTime  @default(now())
  shiftEnd        DateTime?
  modalAwal       Decimal   @db.Decimal(10, 2)
  uangFisikTutup  Decimal?  @db.Decimal(10, 2)
  saldoSeharusnya Decimal?  @db.Decimal(10, 2)
  selisih         Decimal?  @db.Decimal(10, 2)
  status          String    @default("open") // open | closed
  catatan         String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  storeShift StoreShift? @relation(fields: [storeShiftId], references: [id], onDelete: SetNull)
  kasir      User        @relation(fields: [kasirId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([kasirId])
  @@index([storeShiftId])
  @@index([tenantId, kasirId])
  @@index([tenantId, status])
  @@index([tenantId, shiftStart])
  @@map("cash_shifts")
}
// Device Token Model (For push notifications)
model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String // ios | android | web
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, isActive])
  @@map("device_tokens")
}

// Courier Config Model (For storing courier API credentials)
model CourierConfig {
  id        String   @id @default(uuid())
  tenantId  String
  courier   String // JNE | JNT | POS
  apiKey    String
  apiSecret String
  baseUrl   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, courier])
  @@index([tenantId])
  @@index([tenantId, courier])
  @@map("courier_configs")
}

// System Settings Model (For storing system-level configuration)
model SystemSettings {
  id                   String   @id @default(cuid())
  appName              String   @default("Warungin")
  version              String   @default("1.3.0")
  maintenanceMode      Boolean  @default(false)
  allowRegistration    Boolean  @default(false)
  maxTenants           Int      @default(1000)
  maxUsersPerTenant    Int      @default(50)
  multiOutletEnabled   Boolean  @default(true)
  deliveryEnabled      Boolean  @default(false)
  accountingEnabled    Boolean  @default(false)
  customSettings       Json? // JSON for additional custom settings
  lastModifiedBy       String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("system_settings")
}


