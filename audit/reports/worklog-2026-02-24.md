# Warungin Audit Worklog (Up to 2026-02-24)

## Scope and approach

- Deployment target: Coolify (Warungin only).
- Audit method: page-by-page FE-BE contract checks (route -> auth/tenant scope -> service -> DB model).
- Priority: correctness and multi-tenant safety over speed.

## What has been completed so far

### Tenant detail and subscription flow (`/app/tenants`, `/app/tenants/:id`)

- Fixed user password flow from invalid endpoint to secure temp reset endpoint.
  - Added `POST /users/:id/reset-password-temp`.
  - Added password hash + `mustChangePassword` logic in users service.
- Fixed tenant store edit payload validation issue by sending DTO-safe fields only.
- Fixed subscription semantics:
  - Added `durationDeltaDays` (+/-), `createBilling`, `purchasedBy`, `note` behavior.
  - Removed `PAST_DUE`/"Tunggakan" ambiguity from tenant UI flow.
  - Added `FROZEN` behavior and explicit `CANCELLED` end-date handling.
  - Prevented non-billable edits from creating billing/history spam.
- Hardened super-admin safety checks for destructive self-actions.

### Customers page (`/app/customers`)

- Fixed quick points contract mismatch:
  - Frontend changed from `PUT /customers/:id` with unsupported field to `POST /customers/:id/loyalty-points`.
- Fixed route precedence in customers controller:
  - Moved static routes (`/export`, `/stats`) before dynamic `/:id` route.

### Orders page (`/app/orders`)

- Added query contract support in orders list:
  - `search`, status/date/outlet/customer filters, kitchen filters, sorting.
- Fixed route precedence for `/orders/search` and `/orders/by-status` before `/:id`.
- Enriched `/orders/:id` detail payload with related entities needed by UI.
- Aligned bulk action responses (`deleted/refunded/failed/errors`) with UI expectation.

### Finance transactions page (`/app/finance/transactions`)

- Aligned FE mapping with `/orders` response shape.
- Fixed status enum usage to backend values.
- Removed dependency on missing `/orders/export`; export now uses normalized in-memory data.
- Added detail fetch on demand via `/orders/:id`.

### Retention management page (`/app/settings/retention`)

- Implemented missing backend module and endpoints:
  - `GET /retention/stats`
  - `POST /retention/orders|transactions|reports|audit-logs|contact-submissions|demo-requests`
  - `POST /retention/apply-all`
- Added super-admin role protection and response shape compatibility for existing frontend usage.

### Reports page (`/app/reports`)

- Implemented missing `GET /reports/tenant` endpoint consumed by reports page + export modal.
- Added support for `reportType` variants and period/date filters used by frontend:
  - `sales`, `financial`, `product`, `customers`, `inventory`
- Added optional product hydration used by report detail view.

### Analytics page (`/app/analytics`) - code fixed, pending deployment decision

- Added analytics custom report endpoints used by frontend:
  - `POST /analytics/custom-reports`
  - `GET /analytics/custom-reports/:id/export`
- Added CSV export generation for custom reports by report data type.
- Fixed store comparison source contract in frontend:
  - Switched to `/analytics/revenue-by-outlet` and mapped fields correctly.
- Fixed export filename extension mismatch (`.csv` instead of `.xlsx`).
- Guarded division by zero in store comparison CSV export.

## Tests and verification added

- Added/updated API smoke specs (unauth guard coverage):
  - `client/cypress/e2e/tenant-page-api.cy.ts`
  - `client/cypress/e2e/customers-page-api.cy.ts`
  - `client/cypress/e2e/orders-page-api.cy.ts`
  - `client/cypress/e2e/retention-page-api.cy.ts`
  - `client/cypress/e2e/reports-page-api.cy.ts`
  - `client/cypress/e2e/analytics-page-api.cy.ts`
- Made Cypress config env-driven (`baseUrl` and `API_BASE`) for local/remote runs.
- Repeated FE/BE build validation after each contract fix (`client` and `nest`).

## Important root-cause found for current tenant-detail store picker issue

Issue reported: in super-admin Tenant Detail -> Edit User (staff/cashier), store list is empty even though outlet exists.

Root cause identified in API interceptor:

- `client/src/api/index.ts` always overwrote `x-tenant-id` with globally selected tenant for super-admin.
- `UserEditModal` already sends explicit tenant scope (`tenantId` param + header from `TenantDetail`).
- Overwrite could force wrong tenant context (header precedence), causing `/outlets` to return empty list for another tenant.

Fix implemented locally:

- Interceptor now respects explicit tenant scope from caller first:
  - keep existing `x-tenant-id` if already set,
  - else use explicit `params.tenantId`,
  - else fallback to global selected tenant.

File changed:

- `client/src/api/index.ts`

## Commits history (recent, high-impact)

- `af58072` tenant user/store flows + subscription semantics
- `dbd01a6` temp password parsing + subscription status source
- `73bf06d` customer contracts + Coolify build hardening
- `1a1a62b` orders query contracts + route precedence
- `8ad6e35` finance transactions contract alignment
- `87ee77e` retention endpoints implementation
- `00da842` reports tenant endpoint implementation
- `7cf9e2d` analytics custom report + outlet comparison contract alignment

## Current note from latest request

- Per user request, stop deployment-first flow and focus on audit + fixes first.
- Next step should verify Tenant Detail edit-user store picker fix in runtime after approval to deploy latest relevant commit.

## Latest deep audit on Tenant Detail (no deploy yet)

### A. Store picker empty in Edit User (Super Admin)

- Confirmed likely failure chain:
  - `TenantDetail` passes explicit tenant context to `UserEditModal`.
  - `UserEditModal` calls `GET /outlets` with scoped tenant config.
  - global API interceptor previously overwrote `x-tenant-id` for super-admin with globally selected tenant.
  - request could resolve to wrong tenant -> outlets list appears empty.
- Fix already applied locally in `client/src/api/index.ts` (explicit scope now has priority).
- Additional hardening applied in `UserEditModal`:
  - outlet fetch now requests larger page size (`limit=500`) to avoid missing stores when tenant has many outlets,
  - fallback to `/outlets/active` remains in place for resilience.

### B. Silent permission overwrite risk when editing user from Tenant Detail

- `GET /tenants/:id/detail` user list previously did not include `permissions` field.
- `UserEditModal` initializes defaults when permissions are absent; saving could unintentionally overwrite existing permission/store assignment.
- Fix applied locally:
  - include `permissions` in tenant detail users payload.
  - file: `nest/src/modules/tenants/tenants.service.ts`.

### C. Additional route precedence issues found during tenant-detail API audit

- `users.controller.ts` had `GET /users/:id` before `GET /users/export|stats` (static routes could be shadowed).
- `outlets.controller.ts` had `GET /outlets/:id` before `GET /outlets/active`.
- Fixes applied locally by moving static routes before dynamic `:id` routes.
  - files:
    - `nest/src/modules/users/users.controller.ts`
    - `nest/src/modules/outlets/outlets.controller.ts`

### D. Validation/build status for latest local fixes

- `nest npm run build` passed after tenant-detail deep audit fixes.
- No deployment has been executed for these latest local changes (per request).

### E. Deeper auth/API/DB hardening (latest local pass)

- Added backend-side permission/store assignment validation in user update flow:
  - normalize legacy role `STAFF` -> `CASHIER`.
  - validate `assignedStoreId` for `CASHIER/KITCHEN` must exist in same tenant outlets.
  - validate `allowedStoreIds` for `SUPERVISOR` must exist in same tenant outlets.
  - clear store-assignment fields when role does not require store scoping.
  - file: `nest/src/modules/users/users.service.ts`.
- Added frontend submit guard to prevent invalid save payload:
  - Supervisor must have at least one store access.
  - Cashier/Kitchen must have assigned store.
  - file: `client/src/components/UserEditModal.vue`.
- Added supervisor-role option safeguard in edit form:
  - if existing user role is `SUPERVISOR` but addon state temporarily not loaded/active, role option stays visible to prevent accidental role downgrade on save.
  - file: `client/src/components/UserEditModal.vue`.

### F. Extra API smoke coverage for tenant-detail user edit chain

- Added `client/cypress/e2e/tenant-detail-user-edit-api.cy.ts`.
- Coverage includes:
  - unauth guard for `GET /outlets` and `GET /outlets/active`.
  - authenticated tenant-detail payload assertion for user `permissions` field (env-gated).
- Extended authenticated scenarios prepared (env-gated):
  - persist cashier `assignedStoreId` and verify it survives tenant-detail reload,
  - reject invalid cross-tenant/non-existent assigned store IDs.
- Latest run result (without auth env): `5 tests, 2 passing, 3 pending, 0 failing`.
