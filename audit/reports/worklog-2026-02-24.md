# Warungin Audit Worklog (Up to 2026-02-24)

## Scope and approach

- Deployment target: Coolify (Warungin only).
- Audit method: page-by-page FE-BE contract checks (route -> auth/tenant scope -> service -> DB model).
- Priority: correctness and multi-tenant safety over speed.

## What has been completed so far

### Tenant detail and subscription flow (`/app/tenants`, `/app/tenants/:id`)

- Fixed user password flow from invalid endpoint to secure temp reset endpoint.
  - Added `POST /users/:id/reset-password-temp`.
  - Added password hash + `mustChangePassword` logic in users service.
- Fixed tenant store edit payload validation issue by sending DTO-safe fields only.
- Fixed subscription semantics:
  - Added `durationDeltaDays` (+/-), `createBilling`, `purchasedBy`, `note` behavior.
  - Removed `PAST_DUE`/"Tunggakan" ambiguity from tenant UI flow.
  - Added `FROZEN` behavior and explicit `CANCELLED` end-date handling.
  - Prevented non-billable edits from creating billing/history spam.
- Hardened super-admin safety checks for destructive self-actions.

### Customers page (`/app/customers`)

- Fixed quick points contract mismatch:
  - Frontend changed from `PUT /customers/:id` with unsupported field to `POST /customers/:id/loyalty-points`.
- Fixed route precedence in customers controller:
  - Moved static routes (`/export`, `/stats`) before dynamic `/:id` route.

### Orders page (`/app/orders`)

- Added query contract support in orders list:
  - `search`, status/date/outlet/customer filters, kitchen filters, sorting.
- Fixed route precedence for `/orders/search` and `/orders/by-status` before `/:id`.
- Enriched `/orders/:id` detail payload with related entities needed by UI.
- Aligned bulk action responses (`deleted/refunded/failed/errors`) with UI expectation.

### Finance transactions page (`/app/finance/transactions`)

- Aligned FE mapping with `/orders` response shape.
- Fixed status enum usage to backend values.
- Removed dependency on missing `/orders/export`; export now uses normalized in-memory data.
- Added detail fetch on demand via `/orders/:id`.

### Retention management page (`/app/settings/retention`)

- Implemented missing backend module and endpoints:
  - `GET /retention/stats`
  - `POST /retention/orders|transactions|reports|audit-logs|contact-submissions|demo-requests`
  - `POST /retention/apply-all`
- Added super-admin role protection and response shape compatibility for existing frontend usage.

### Reports page (`/app/reports`)

- Implemented missing `GET /reports/tenant` endpoint consumed by reports page + export modal.
- Added support for `reportType` variants and period/date filters used by frontend:
  - `sales`, `financial`, `product`, `customers`, `inventory`
- Added optional product hydration used by report detail view.

### Analytics page (`/app/analytics`) - code fixed, pending deployment decision

- Added analytics custom report endpoints used by frontend:
  - `POST /analytics/custom-reports`
  - `GET /analytics/custom-reports/:id/export`
- Added CSV export generation for custom reports by report data type.
- Fixed store comparison source contract in frontend:
  - Switched to `/analytics/revenue-by-outlet` and mapped fields correctly.
- Fixed export filename extension mismatch (`.csv` instead of `.xlsx`).
- Guarded division by zero in store comparison CSV export.

## Tests and verification added

- Added/updated API smoke specs (unauth guard coverage):
  - `client/cypress/e2e/tenant-page-api.cy.ts`
  - `client/cypress/e2e/customers-page-api.cy.ts`
  - `client/cypress/e2e/orders-page-api.cy.ts`
  - `client/cypress/e2e/retention-page-api.cy.ts`
  - `client/cypress/e2e/reports-page-api.cy.ts`
  - `client/cypress/e2e/analytics-page-api.cy.ts`
- Made Cypress config env-driven (`baseUrl` and `API_BASE`) for local/remote runs.
- Repeated FE/BE build validation after each contract fix (`client` and `nest`).

## Important root-cause found for current tenant-detail store picker issue

Issue reported: in super-admin Tenant Detail -> Edit User (staff/cashier), store list is empty even though outlet exists.

Root cause identified in API interceptor:

- `client/src/api/index.ts` always overwrote `x-tenant-id` with globally selected tenant for super-admin.
- `UserEditModal` already sends explicit tenant scope (`tenantId` param + header from `TenantDetail`).
- Overwrite could force wrong tenant context (header precedence), causing `/outlets` to return empty list for another tenant.

Fix implemented locally:

- Interceptor now respects explicit tenant scope from caller first:
  - keep existing `x-tenant-id` if already set,
  - else use explicit `params.tenantId`,
  - else fallback to global selected tenant.

File changed:

- `client/src/api/index.ts`

## Commits history (recent, high-impact)

- `af58072` tenant user/store flows + subscription semantics
- `dbd01a6` temp password parsing + subscription status source
- `73bf06d` customer contracts + Coolify build hardening
- `1a1a62b` orders query contracts + route precedence
- `8ad6e35` finance transactions contract alignment
- `87ee77e` retention endpoints implementation
- `00da842` reports tenant endpoint implementation
- `7cf9e2d` analytics custom report + outlet comparison contract alignment

## Current note from latest request

- Per user request, stop deployment-first flow and focus on audit + fixes first.
- Next step should verify Tenant Detail edit-user store picker fix in runtime after approval to deploy latest relevant commit.

## Latest deep audit on Tenant Detail (no deploy yet)

### A. Store picker empty in Edit User (Super Admin)

- Confirmed likely failure chain:
  - `TenantDetail` passes explicit tenant context to `UserEditModal`.
  - `UserEditModal` calls `GET /outlets` with scoped tenant config.
  - global API interceptor previously overwrote `x-tenant-id` for super-admin with globally selected tenant.
  - request could resolve to wrong tenant -> outlets list appears empty.
- Fix already applied locally in `client/src/api/index.ts` (explicit scope now has priority).
- Additional hardening applied in `UserEditModal`:
  - outlet fetch now requests larger page size (`limit=500`) to avoid missing stores when tenant has many outlets,
  - fallback to `/outlets/active` remains in place for resilience.

### B. Silent permission overwrite risk when editing user from Tenant Detail

- `GET /tenants/:id/detail` user list previously did not include `permissions` field.
- `UserEditModal` initializes defaults when permissions are absent; saving could unintentionally overwrite existing permission/store assignment.
- Fix applied locally:
  - include `permissions` in tenant detail users payload.
  - file: `nest/src/modules/tenants/tenants.service.ts`.

### C. Additional route precedence issues found during tenant-detail API audit

- `users.controller.ts` had `GET /users/:id` before `GET /users/export|stats` (static routes could be shadowed).
- `outlets.controller.ts` had `GET /outlets/:id` before `GET /outlets/active`.
- Fixes applied locally by moving static routes before dynamic `:id` routes.
  - files:
    - `nest/src/modules/users/users.controller.ts`
    - `nest/src/modules/outlets/outlets.controller.ts`

### D. Validation/build status for latest local fixes

- `nest npm run build` passed after tenant-detail deep audit fixes.
- No deployment has been executed for these latest local changes (per request).

### E. Deeper auth/API/DB hardening (latest local pass)

- Added backend-side permission/store assignment validation in user update flow:
  - normalize legacy role `STAFF` -> `CASHIER`.
  - validate `assignedStoreId` for `CASHIER/KITCHEN` must exist in same tenant outlets.
  - validate `allowedStoreIds` for `SUPERVISOR` must exist in same tenant outlets.
  - clear store-assignment fields when role does not require store scoping.
  - file: `nest/src/modules/users/users.service.ts`.
- Added frontend submit guard to prevent invalid save payload:
  - Supervisor must have at least one store access.
  - Cashier/Kitchen must have assigned store.
  - file: `client/src/components/UserEditModal.vue`.
- Added supervisor-role option safeguard in edit form:
  - if existing user role is `SUPERVISOR` but addon state temporarily not loaded/active, role option stays visible to prevent accidental role downgrade on save.
  - file: `client/src/components/UserEditModal.vue`.

### F. Extra API smoke coverage for tenant-detail user edit chain

- Added `client/cypress/e2e/tenant-detail-user-edit-api.cy.ts`.
- Coverage includes:
  - unauth guard for `GET /outlets` and `GET /outlets/active`.
  - authenticated tenant-detail payload assertion for user `permissions` field (env-gated).
- Extended authenticated scenarios prepared (env-gated):
  - persist cashier `assignedStoreId` and verify it survives tenant-detail reload,
  - reject invalid cross-tenant/non-existent assigned store IDs.
- Latest run result (without auth env): `5 tests, 2 passing, 3 pending, 0 failing`.

### G. Role-policy hardening for Supervisor (auth/API/DB)

- Tenant Detail add-user form now hides Supervisor option unless `SUPERVISOR_ROLE` addon is active for tenant.
- Add-user submit path now blocks Supervisor creation when addon is not active.
- Backend now enforces same policy (cannot bypass from API client):
  - `TenantsService.createTenantUser` rejects Supervisor role when addon inactive.
  - `UsersService.createUser/updateUser` rejects Supervisor role when addon inactive.
- Error semantics aligned for policy violation: create-tenant-user supervisor without addon now returns `400 Bad Request` (policy failure), not conflict semantics.
- This closes FE-only validation gaps and keeps role-policy consistent at DB write layer.

### H. Extended tenant-detail edit regression matrix

- `tenant-detail-user-edit-api.cy.ts` extended with supervisor-addon policy scenario:
  - if addon active -> supervisor creation expected success,
  - if addon inactive -> supervisor creation expected reject (`400/409`).
- Added role-switch safety scenario:
  - switching `ADMIN_TENANT` -> `CASHIER` without store permissions must be rejected (`400`).
- Added downgrade cleanup scenario:
  - switching `CASHIER` -> `ADMIN_TENANT` must remove `assignedStoreId/allowedStoreIds` from persisted permissions.
- Latest spec run (without auth env): `8 tests, 2 passing, 6 pending, 0 failing`.

### I. Tenant-detail error semantics normalization (frontend)

- Added centralized API error extractor in `TenantDetail.vue` to correctly surface:
  - string messages,
  - validator array messages,
  - nested wrapped messages.
- Applied across tenant-detail actions (subscription, addons, users, stores) so super admin now sees precise policy/validation errors from backend instead of generic fallback text.

### J. Runtime verification automation pack

- Added root verifier command:
  - `npm run verify:tenant-detail:runtime`
  - script: `scripts/verify-tenant-detail-runtime.js`
  - includes backend health probe + tenant-detail API regression spec execution.
- Added Cypress env template for authenticated runs:
  - `client/cypress.env.example.json`.

### K. Authenticated runtime verification result (post-deploy)

- Full authenticated tenant-detail verifier executed with provided credentials and tenant context.
- Result: `8 tests, 8 passing, 0 failing` on `client/cypress/e2e/tenant-detail-user-edit-api.cy.ts`.
- Additional hotfix deployed during verification:
  - removed unsupported query params from outlet requests (`/outlets`) in user-edit flow,
  - aligned Cypress regression spec with strict outlet query validation.

### L. Runtime stabilization gate for full page-by-page sweep

- Hardened backend exception path to prevent intermittent process crash chain observed during broader sweeps:
  - `nest/src/common/dto/response.dto.ts`: `ErrorResponseDto` now normalizes optional `errors` safely before length access.
  - `nest/src/common/filters/global-exception.filter.ts`: skips response write when headers already sent/writable ended and safely maps string/object validation errors.
- Hardened reverse-proxy compatibility:
  - `nest/src/main.ts`: set Express trust proxy using env `TRUST_PROXY` (default `1`) before applying rate-limit middleware.
- Added runtime verifier for full page API smoke chain:
  - root command: `npm run verify:pages:runtime`
  - runner: `scripts/verify-pages-runtime.js`
  - executes specs: tenant-page, customers, orders, retention, reports, analytics, tenant-detail.
- Added per-page Cypress script aliases in `client/package.json` for deterministic single-spec execution.
- Validation evidence (latest run without authenticated env vars):
  - health: `status=ok`, `database=connected`
  - tenant-page: `1 pass, 3 pending`
  - customers: `2 pass, 2 pending`
  - orders: `2 pass, 1 pending`
  - retention: `2 pass`
  - reports: `2 pass`
  - analytics: `3 pass`
  - tenant-detail-user-edit: `2 pass, 6 pending`

### M. Authenticated sweep follow-up and crash pinpoint

- Authenticated specs executed with provided superadmin credentials and tenant context.
- Passing specs after assertion alignment:
  - `tenant-page-api.cy.ts`: `4/4 passing`
  - `orders-page-api.cy.ts`: `3/3 passing`
  - `tenant-detail-user-edit-api.cy.ts`: `8/8 passing` (sequential rerun)
- Persistent failure reproduced:
  - `customers-page-api.cy.ts` fails on `POST /customers/:id/loyalty-points` with Cloudflare `502` and subsequent cleanup delete can also return `502`.
- Root cause isolated in backend runtime path:
  - `nest/src/common/interceptors/performance-monitoring.interceptor.ts` calculated `JSON.stringify(data).length`.
  - For controller handlers using `@Res` and returning `void`, `JSON.stringify(undefined)` yields `undefined`, then `.length` throws and can crash the process.
- Fix applied locally:
  - safe response-size calculation in performance interceptor (`serialized ? serialized.length : 0`).
  - backend build check passed (`nest npm run build`).

### N. Coolify deploy + post-deploy authenticated verification

- Coolify deploy executed for commit `e8c4c7a`.
  - Started: `2026-02-24 15:38:05 UTC`
  - Ended: `2026-02-24 15:47:27 UTC`
  - Duration: `09m 22s`
- Post-deploy authenticated verification rerun (live):
  - `tenant-page-api.cy.ts`: `4/4 passing`
  - `customers-page-api.cy.ts`: `4/4 passing` (loyalty points flow stable; previous `502` no longer reproduced)
  - `orders-page-api.cy.ts`: `3/3 passing`
  - `finance-transactions-page-api.cy.ts`: `4/4 passing`
  - `retention-page-api.cy.ts`: `2/2 passing`
  - `reports-page-api.cy.ts`: `2/2 passing`
  - `analytics-page-api.cy.ts`: `3/3 passing`
  - `tenant-detail-user-edit-api.cy.ts`: `8/8 passing`
- Added finance transactions contract spec and script hooks:
  - `client/cypress/e2e/finance-transactions-page-api.cy.ts`
  - `client/package.json` script `test:finance:api`
  - `scripts/verify-pages-runtime.js` now includes `finance-transactions` in the sequential verifier list.
- Final chained authenticated matrix rerun passed in one sequence across all page API specs (tenant, customers, orders, finance, retention, reports, analytics, tenant-detail).

### O. Finance UI-driven smoke verification

- Added UI smoke spec for finance transactions page:
  - `client/cypress/e2e/finance-transactions-page-ui.cy.ts`
  - script alias: `client/package.json` -> `test:finance:ui`
- Live authenticated run result:
  - `3/3 passing` (`redirect unauth -> login`, `authenticated load/filter`, `detail modal open`).

### P. Final chained authenticated rerun (live)

- Executed final explicit-env chained API verification after finance UI addition:
  - `tenant-page-api.cy.ts`: `4/4 passing`
  - `customers-page-api.cy.ts`: `4/4 passing`
  - `orders-page-api.cy.ts`: `3/3 passing`
  - `finance-transactions-page-api.cy.ts`: `4/4 passing`
  - `retention-page-api.cy.ts`: `2/2 passing`
  - `reports-page-api.cy.ts`: `2/2 passing`
  - `analytics-page-api.cy.ts`: `3/3 passing`
  - `tenant-detail-user-edit-api.cy.ts`: `8/8 passing`
- Note: helper command `npm run verify:pages:runtime` still requires env injection at process level; in this shell, direct inline env export via PowerShell was not applied correctly, so authenticated proof uses explicit `--env ...` per spec command.

### Q. Phase execution: UI smoke expansion

- Implemented key page UI smoke specs for closure phase:
  - `client/cypress/e2e/payment-callback-ui.cy.ts`
  - `client/cypress/e2e/customers-page-ui.cy.ts`
  - `client/cypress/e2e/orders-page-ui.cy.ts`
  - `client/cypress/e2e/tenant-detail-page-ui.cy.ts`
- Added script aliases in `client/package.json`:
  - `test:payment-callback:ui`, `test:customers:ui`, `test:orders:ui`, `test:tenant-detail:ui`
- Added root runner:
  - `scripts/verify-pages-ui-runtime.js`
  - root command `npm run verify:pages:ui-runtime`
- Live runtime results:
  - payment callback UI `3/3 passing`
  - customers UI `3/3 passing`
  - orders UI `3/3 passing`
  - tenant detail UI `2/2 passing`

### R. Final stabilization rerun after UI auth-state hardening

- Hardened UI smoke spec isolation by clearing local auth state (`clearCookies`, `clearLocalStorage`) before each test in:
  - `finance-transactions-page-ui.cy.ts`
  - `customers-page-ui.cy.ts`
  - `orders-page-ui.cy.ts`
  - `tenant-detail-page-ui.cy.ts`
- Orders UI smoke adjusted to handle both compact/desktop detail action selectors and prevent search input overlay interaction failure.
- Tenant detail UI smoke adjusted to tolerate transient loading/error states while still validating users-tab path when detail data is available.
- Re-ran full live matrices after hardening:
  - UI matrix pass: payment callback, finance, customers, orders, tenant detail.
  - API matrix pass: tenant, customers, orders, finance, retention, reports, analytics, tenant-detail-user-edit.

### S. Post-deploy rerun confirmation

- After latest successful deployment confirmation, reran live matrices again and results remain stable.
- UI post-deploy matrix:
  - payment callback `3/3`, finance `3/3`, customers `3/3`, orders `3/3`, tenant detail `2/2`.
- API post-deploy matrix:
  - tenant `4/4`, customers `4/4`, orders `3/3`, finance `4/4`, retention `2/2`, reports `2/2`, analytics `3/3`, tenant-detail-user-edit `8/8`.
- Remaining observation:
  - `/health` identity currently reports `appCommitSha=ce6c21a` while deployed commit is `e8c4c7a`; runtime behavior indicates hotfix active, so this is tracked as deployment identity observability drift rather than functional blocker.

### T. Observability + payment callback contract hardening

- Added backend health identity fallback strategy to reduce commit-sha drift risk on varying deployment providers:
  - file: `nest/src/common/health/health.service.ts`
  - `appCommitSha` now resolves from prioritized env keys (`APP_COMMIT_SHA`, `SOURCE_COMMIT`, `COOLIFY_GIT_COMMIT_SHA`, `GITHUB_SHA`, `COMMIT_SHA`, `VERCEL_GIT_COMMIT_SHA`).
  - identity payload now includes `deploymentId` and `containerId` for runtime provenance.
- Added payment callback/webhook API contract smoke spec:
  - `client/cypress/e2e/payment-webhook-api.cy.ts`
  - script alias: `client/package.json` -> `test:payment-webhook:api`
  - included in chained API verifier list (`scripts/verify-pages-runtime.js`).
- Live contract evidence:
  - `payment-webhook-api.cy.ts`: `4/4 passing`
  - verifies webhook routes are public (not `401`) and payment status route remains auth guarded.
- Validation:
  - `nest npm run build` passed after health identity changes.

### U. Post-deploy verification for observability fallback commit

- Deployment for commit `f4ce851` confirmed successful by operator.
- Live checks after deployment:
  - `GET https://warungin-api.faiznute.site/health` -> `200`, `database=connected`.
  - `payment-webhook-api.cy.ts` -> `4/4 passing` (status route auth-protected, callback/webhook routes public as expected).
- Remaining gap:
  - health identity still returns `appCommitSha=ce6c21a` and no `deploymentId` field.
  - This indicates app-side fallback is deployed, but runtime env does not provide/refresh commit provenance keys correctly (likely stale `APP_COMMIT_SHA` in deployment environment).

### V. Follow-up observability hardening pass

- Implemented a second health identity pass to avoid stale static commit override:
  - `appCommitSha` now resolves only from dynamic deployment commit keys (`SOURCE_COMMIT`, `COOLIFY_GIT_COMMIT_SHA`, `GITHUB_SHA`, `COMMIT_SHA`, `VERCEL_GIT_COMMIT_SHA`).
  - Added explicit diagnostics fields in `/health` identity:
    - `commitSource` (which env key was used)
    - `configuredAppCommitSha` (raw static value, if configured)
- Purpose: prevent misleading stale SHA in identity while preserving diagnostic visibility.
- Validation: `nest npm run build` passed.

### W. Post-deploy confirmation for commit identity fix

- Deployment for commit `c6e6d80` confirmed successful and healthy.
- Live `/health` verification now shows:
  - `appCommitSha=c6e6d80cb5cf0e239028f28453222287ccafbaa0`
  - `commitSource=SOURCE_COMMIT`
  - `configuredAppCommitSha=ce6c21a` (diagnostic only)
  - database `connected`
- Outcome: active commit identity drift is resolved; remaining static configured SHA is no longer used as authoritative runtime commit source.

### X. Phase 1 quality cleanup (lint burn-down on high-traffic modules)

- Ran focused lint audit on high-traffic scope (`views/tenants`, `views/customers`, `views/orders`, `views/finance`, related stores/components).
- Applied warning cleanup in active flows:
  - `client/src/views/orders/Orders.vue`
    - removed unused permission/function blocks,
    - removed template TS assertion causing deprecated-filter lint error,
    - simplified unused catch binding.
  - `client/src/views/finance/ProfitLossReport.vue`
    - removed unused auth store binding.
  - `client/src/views/tenants/SupportTickets.vue`
    - removed unused catch binding.
  - `client/src/views/tenants/components/TenantProducts.vue`
    - removed unused catch binding.
  - `client/src/stores/pos.store.ts`
    - removed unused catch binding.
- Result of focused lint scan:
  - before: `38 warnings, 0 errors`
  - after: `28 warnings, 0 errors`
- Regression checks after cleanup:
  - `orders-page-api.cy.ts`: `3/3 passing`
  - `orders-page-ui.cy.ts`: `3/3 passing` (with selector hardening for detail action fallback)

### Y. Phase 2 UI journey expansion (deeper non-destructive flows)

- Expanded UI journey coverage with additional safe interactions (no destructive writes):
  - `client/cypress/e2e/customers-page-ui.cy.ts`
    - added detail -> edit modal open/close path.
  - `client/cypress/e2e/orders-page-ui.cy.ts`
    - added status-control visibility journey (editable select vs readonly badge).
  - `client/cypress/e2e/tenant-detail-page-ui.cy.ts`
    - added add-user modal open + required field visibility path.
- Live regression evidence after expansion:
  - customers UI `4/4 passing`
  - orders UI `4/4 passing`
  - tenant detail UI `3/3 passing`
- Lint verification on changed app/spec files: no errors.
